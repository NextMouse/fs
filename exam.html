<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿è€ƒè¯•ç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0idXJsKCNncmFkaWVudDApIi8+CjxwYXRoIGQ9Ik04IDEySDI0TTggMTZIMjBNOCAyMEgyMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwIiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMSI+CiAgICAgIDxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KPC9zdmc+Cjwvc3ZnPgo=" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin-left: calc(250px + 20px + (100vw - 250px - 800px) / 2);
            /* 250pxå¯¼èˆªå®½åº¦ + 20pxé—´è· + å‰©ä½™ç©ºé—´çš„å±…ä¸­åç§» */
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: margin-left 0.3s ease;
        }

        .container.nav-collapsed {
            margin-left: auto;
            margin-right: auto;
        }

        .main-content {
            width: 100%;
            margin-left: 0;
        }

        .question-nav {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
            box-sizing: border-box;
            transition: transform 0.3s ease;
        }

        .question-nav.collapsed {
            transform: translateX(-250px);
        }

        .nav-toggle-btn {
            position: fixed;
            left: 250px;
            top: 20px;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 0 15px 15px 0;
            cursor: pointer;
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .nav-toggle-btn:hover {
            background: #5a6fd8;
            transform: translateX(2px);
        }

        .nav-toggle-btn.collapsed {
            left: 0;
            border-radius: 0 15px 15px 0;
        }

        .nav-toggle-btn.collapsed:hover {
            transform: translateX(2px);
        }

        .question-nav h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }

        .wrong-questions-section {
            margin: 20px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }

        .wrong-questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .wrong-questions-title {
            font-size: 14px;
            font-weight: 600;
            color: #856404;
        }

        .wrong-count {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }

        .retry-wrong-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 8px;
        }

        .retry-wrong-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .retry-wrong-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* éšæœºè€ƒè¯•å¼¹çª—æ ·å¼ */
        .random-exam-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .random-exam-modal.show {
            display: flex;
        }

        .random-exam-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .random-exam-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .random-exam-header h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .random-exam-info {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
        }

        .random-exam-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .random-question {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .random-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .random-question-number {
            font-weight: 600;
            color: #495057;
        }

        .random-question-score {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .random-question-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 15px;
            color: #333;
        }

        .random-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .random-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            user-select: none;
        }

        .random-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .random-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .random-option.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .random-option.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .random-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .random-exam-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .random-exam-footer.mobile {
            flex-direction: column;
            gap: 15px;
        }

        .random-exam-footer.mobile .random-exam-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .random-exam-footer.mobile .random-exam-btn {
            flex: 1;
            max-width: 120px;
            padding: 8px 12px;
            font-size: 12px;
        }

        .random-exam-footer.mobile .random-exam-btn.primary {
            order: -1;
            max-width: none;
            flex: none;
            width: 100%;
            margin-bottom: 10px;
            height: 40px;
            line-height: 1;
        }

        .random-exam-footer.mobile .random-exam-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .random-exam-footer.mobile .random-exam-buttons .random-exam-btn {
            flex: 1;
            max-width: 120px;
            padding: 10px 16px;
            font-size: 14px;
            height: 40px;
            line-height: 1;
        }

        .random-exam-footer.mobile .random-exam-buttons .random-exam-btn.primary {
            max-width: 160px;
        }

        .random-exam-footer.mobile .random-exam-actions {
            display: none !important;
        }

        .random-exam-footer.mobile .random-exam-progress {
            text-align: center;
            font-size: 14px;
        }

        .random-exam-progress {
            font-size: 14px;
            color: #6c757d;
        }

        .random-exam-buttons {
            display: flex;
            gap: 10px;
        }

        .random-exam-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .random-exam-btn.primary {
            background: #667eea;
            color: white;
        }

        .random-exam-btn.primary:hover {
            background: #5a6fd8;
        }

        .random-exam-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .random-exam-btn.secondary:hover {
            background: #5a6268;
        }

        .random-exam-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* éšæœºè€ƒè¯•æŒ‰é’®æ ·å¼ */
        .random-exam-btn-nav {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .random-exam-btn-nav:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }



        .question-list {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .question-item {
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
        }

        .question-item:hover {
            background: #dee2e6;
            border-color: #adb5bd;
        }

        .question-item.current {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .question-item.correct {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }

        .question-item.incorrect {
            background: #dc3545;
            color: white;
            border-color: #bd2130;
        }

        .question-item.unanswered {
            background: #6c757d;
            color: white;
            border-color: #545b62;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .question-container {
            padding: 30px 30px 100px 30px;
            /* åº•éƒ¨ç•™å‡º100pxç©ºé—´ç»™æŒ‰é’® */
            height: 800px;
            /* è®¾ç½®å›ºå®šé«˜åº¦ï¼Œç¡®ä¿ç­”é¢˜çª—å£é«˜åº¦ä¸å˜ */
            position: relative;
            /* ä¸ºæŒ‰é’®å®šä½åšå‡†å¤‡ */
            overflow-y: hidden;
            /* é»˜è®¤éšè—æ»šåŠ¨æ¡ */
        }

        .question-container.scrollable {
            overflow-y: auto;
            /* åªæœ‰åœ¨éœ€è¦æ»šåŠ¨æ—¶æ‰æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }

        /* å†…éƒ¨å¯æ»šåŠ¨åŒºåŸŸï¼šå†…å®¹è¶…å‡ºæ—¶æ»šåŠ¨ï¼Œä½†éšè—æ»šåŠ¨æ¡ */
        .question-scroll {
            height: 100%;
            overflow-y: auto;
            -ms-overflow-style: none;
            /* IE/Edge */
            scrollbar-width: none;
            /* Firefox */
            padding-right: 2px;
            /* é¢„ç•™æç»†ç©ºé—´é¿å…å†…å®¹è¢«è£åˆ‡ */
        }

        .question-scroll::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari éšè—æ»šåŠ¨æ¡ */
        }

        .question-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .question-number {
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 25px;
            color: #333;
        }

        .options {
            margin-bottom: 30px;
            min-height: 200px;
            /* å‡å°‘é€‰é¡¹åŒºåŸŸæœ€å°é«˜åº¦ï¼Œä¸ºAIè§£æç•™å‡ºæ›´å¤šç©ºé—´ */
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .option.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .option.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .option input[type="radio"],
        .option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .answer-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            /* ä»15pxå¢åŠ åˆ°20pxï¼Œæä¾›æ›´å¤šå†…è¾¹è· */
            margin: 20px 0;
            display: none;
            min-height: 100px;
            /* å‡å°‘æœ€å°é«˜åº¦ï¼Œä¸ºAIè§£æç•™å‡ºæ›´å¤šç©ºé—´ */
            position: relative;
            /* ä¸ºAIæŒ‰é’®å®šä½åšå‡†å¤‡ */
        }

        .answer-display.show {
            display: block;
        }

        .answer-text {
            color: #856404;
            font-weight: 500;
            margin-top: 0;
        }

        /* AIè§£ææ ·å¼ */
        .ai-analysis {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            max-height: 450px;
            /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œåœ¨å›ºå®šå®¹å™¨å†…ç•™å‡ºè¶³å¤Ÿç©ºé—´ */
            overflow-y: auto;
            /* å†…éƒ¨å¯æ»šåŠ¨ä½†éšè—æ»šåŠ¨æ¡ */
            -ms-overflow-style: none;
            /* IE/Edge éšè—æ»šåŠ¨æ¡ */
            scrollbar-width: none;
            /* Firefox éšè—æ»šåŠ¨æ¡ */
        }

        .ai-analysis.show {
            display: block;
        }



        .ai-analysis-content {
            color: #495057;
            line-height: 1.6;
            font-size: 14px;
            padding: 10px 0;
            /* æ·»åŠ å†…è¾¹è· */
        }

        .ai-analysis-content .loading {
            text-align: center;
            color: #6c757d;
            padding: 20px 0;
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: #667eea;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
        }



        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }



        .ai-analysis-content .error {
            color: #dc3545;
            text-align: center;
            padding: 20px 0;
        }

        .ai-analysis-content h5 {
            margin: 20px 0 10px 0;
            color: #007bff;
            font-size: 15px;
            font-weight: 600;
        }

        .ai-analysis-content p {
            margin: 10px 0;
            text-align: justify;
        }

        .ai-analysis-content div {
            margin: 8px 0;
            padding-left: 20px;
        }

        /* AIè¿½é—®åŒºåŸŸæ ·å¼ */
        .ai-follow-up {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .ai-follow-up-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .ai-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .ai-input {
            flex: 1;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            resize: vertical;
            min-height: 36px;
            max-height: 100px;
            font-family: inherit;
        }

        .ai-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .ai-send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .ai-send-btn:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .ai-send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .ai-conversation {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        .ai-message.user {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            margin-left: 20px;
        }

        .ai-message.assistant {
            background: #f8f9fa;
            border-left: 3px solid #28a745;
            margin-right: 20px;
        }

        .ai-message.loading {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            text-align: center;
            color: #856404;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .ai-analysis::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
            /* Chrome/Safari éšè—æ»šåŠ¨æ¡ */
        }

        .ai-analysis::-webkit-scrollbar-track {
            background: transparent;
        }

        .ai-analysis::-webkit-scrollbar-thumb {
            background: transparent;
        }

        .ai-analysis::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }

        .ai-analysis-btn-container {
            margin-top: 12px;
            display: flex;
            align-items: center;
        }

        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-ai:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-ai:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            position: absolute;
            /* ç»å¯¹å®šä½ï¼Œç›¸å¯¹äºç­”é¢˜çª—å£å®¹å™¨ */
            bottom: 0;
            /* è·ç¦»å®¹å™¨åº•éƒ¨è·ç¦» */
            left: 0;
            /* è·ç¦»å·¦è¾¹è·ç¦» */
            right: 0;
            /* è·ç¦»å³è¾¹è·ç¦» */
            background: white;
            /* ç¡®ä¿æŒ‰é’®èƒŒæ™¯æ˜¯ç™½è‰² */
            padding: 12px 30px 16px;
            /* å¢åŠ ä¸Šä¸‹å†…è¾¹è·å’Œå·¦å³å†…è¾¹è· */
            border-top: 1px solid #e9ecef;
            z-index: 10;
            /* ç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚ */
        }

        .actions-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .record-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-prev {
            background: #6c757d;
            color: white;
        }

        .btn-prev:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-next {
            background: #007bff;
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            background: #0056b3;
        }

        .btn-submit {
            background: #28a745;
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            background: #1e7e34;
        }

        /* å°æ–‡å­—æŒ‰é’®æ ·å¼ */
        .btn-link {
            background: transparent;
            color: #007bff;
            padding: 6px 8px;
            min-width: auto;
            font-size: 13px;
            border-radius: 4px;
        }

        .btn-link:hover {
            background: rgba(0, 123, 255, 0.08);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .result-summary {
            text-align: center;
            padding: 30px;
            display: none;
        }

        .result-summary.show {
            display: block;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            color: #28a745;
            margin: 20px 0;
        }

        .restart-btn {
            background: #17a2b8;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            background: #138496;
        }

        /* Toast é€šçŸ¥æ ·å¼ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        .toast.warning {
            background: #ffc107;
            color: #333;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                border-radius: 10px;
                margin-left: auto;
                margin-right: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .question-nav {
                position: fixed;
                left: -280px;
                top: 0;
                width: 280px;
                height: 100vh;
                background: #f8f9fa;
                border-right: 1px solid #e9ecef;
                padding: 15px;
                overflow-y: auto;
                z-index: 1000;
                box-sizing: border-box;
                transition: transform 0.3s ease;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .question-nav.show {
                transform: translateX(280px);
            }

            .nav-toggle-btn {
                position: fixed;
                left: 10px;
                top: 10px;
                width: 40px;
                height: 40px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 50%;
                cursor: pointer;
                z-index: 1001;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            }

            .nav-toggle-btn:hover {
                background: #5a6fd8;
                transform: scale(1.1);
            }

            .nav-toggle-btn.show {
                left: 290px;
            }

            .nav-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .nav-overlay.show {
                display: block;
                opacity: 1;
            }

            .question-nav h3 {
                font-size: 16px;
                margin-bottom: 15px;
            }

            .random-exam-btn-nav {
                padding: 12px 16px;
                font-size: 14px;
                margin-bottom: 15px;
            }

            .wrong-questions-section {
                margin: 15px 0;
                padding: 12px;
            }

            .question-list {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .question-item {
                padding: 6px 3px;
                font-size: 11px;
                border-radius: 6px;
            }

            .wrong-questions-section {
                margin: 15px 0;
                padding: 12px;
            }

            .retry-wrong-btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .question-container {
                padding: 20px 20px 120px 20px;
                /* ç§»åŠ¨ç«¯åº•éƒ¨ç•™å‡º120pxç©ºé—´ç»™æŒ‰é’® */
                height: 600px;
                /* ç§»åŠ¨ç«¯è®¾ç½®å›ºå®šé«˜åº¦ */
                overflow-y: hidden;
            }

            .question-container.scrollable {
                overflow-y: auto;
            }

            .options {
                min-height: 150px;
                /* ç§»åŠ¨ç«¯å‡å°‘é€‰é¡¹åŒºåŸŸé«˜åº¦ */
            }

            .ai-analysis {
                padding: 15px;
                margin: 15px 0;
                max-height: 320px;
                /* ç§»åŠ¨ç«¯æå‡æœ€å¤§é«˜åº¦ */
            }

            .ai-analysis-header h4 {
                font-size: 14px;
                text-align: center;
                /* ç¡®ä¿ç§»åŠ¨ç«¯ä¹Ÿå±…ä¸­ */
            }

            .btn-ai {
                padding: 8px 16px;
                font-size: 13px;
            }

            .answer-display {
                padding: 15px;
                /* ç§»åŠ¨ç«¯é€‚å½“å‡å°‘å†…è¾¹è· */
                min-height: 80px;
                /* ç§»åŠ¨ç«¯é€‚å½“å‡å°‘æœ€å°é«˜åº¦ */
            }

            .answer-text {
                margin-top: 40px;
                /* ç§»åŠ¨ç«¯é€‚å½“å‡å°‘é¡¶éƒ¨è¾¹è· */
            }

            .buttons {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                flex-direction: column;
                align-items: center;
                padding: 10px 15px;
                border-top: 1px solid #e9ecef;
            }

            .btn {
                width: 100%;
                max-width: 300px;
            }

            /* ç§»åŠ¨ç«¯æŒ‰é’®å¸ƒå±€ä¼˜åŒ– */
            .actions-row {
                display: flex;
                gap: 8px;
                justify-content: center;
                flex-wrap: wrap;
                width: 100%;
            }

            .actions-row .btn {
                flex: 1;
                max-width: none;
                padding: 8px 12px;
                font-size: 14px;
                min-width: auto;
            }

            .actions-row .btn-submit {
                order: 0;
                max-width: none;
                flex: 1;
                margin-bottom: 0;
                align-self: auto;
            }

            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                max-width: none;
                margin-bottom: 8px;
            }

            .ai-analysis-content {
                font-size: 13px;
                /* ç§»åŠ¨ç«¯é€‚å½“å‡å°å­—ä½“ */
            }

            .ai-analysis-content h5 {
                font-size: 14px;
                margin: 15px 0 8px 0;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border-width: 3px;
            }

            .ai-loading {
                gap: 15px;
            }



            .loading-text {
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>åœ¨çº¿è€ƒè¯•ç³»ç»Ÿ</h1>
                <p>è¯·è®¤çœŸç­”é¢˜ï¼Œç¥æ‚¨å–å¾—å¥½æˆç»©ï¼</p>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalQuestions">0</div>
                    <div class="stat-label">æ€»é¢˜æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="currentQuestion">0</div>
                    <div class="stat-label">å½“å‰é¢˜å·</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="correctCount">0</div>
                    <div class="stat-label">ç­”å¯¹æ•°é‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="incorrectCount">0</div>
                    <div class="stat-label">ç­”é”™æ•°é‡</div>
                </div>
                <div class="stat-item">
                    <button onclick="clearExamState()"
                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">æ¸…é™¤å†å²</button>
                    <div class="stat-label">æ¸…é™¤è®°å½•</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="question-container" id="questionContainer" style="padding-bottom: 140px;">
                <div class="question-scroll" id="questionScroll">
                    <div class="question-type" id="questionType"></div>
                    <div class="question-number" id="questionNumber"></div>
                    <div class="question-text" id="questionText"></div>

                    <div class="options" id="options"></div>

                    <div class="answer-display" id="answerDisplay">
                        <div class="answer-text" id="answerText"></div>
                        <div class="ai-analysis-btn-container">
                            <button class="btn btn-ai" id="aiAnalysisBtn" onclick="toggleAIAnalysis()"
                                style="display: none;">
                                ğŸ¤– AIè§£æ
                            </button>
                        </div>
                    </div>

                    <div class="ai-analysis" id="aiAnalysis" style="display: none;">
                        <div class="ai-analysis-content" id="aiAnalysisContent">
                            <div class="loading">æ­£åœ¨ç”ŸæˆAIè§£æ...</div>
                        </div>

                        <!-- AIè¿½é—®åŒºåŸŸ -->
                        <div class="ai-follow-up" id="aiFollowUp" style="display: none;">
                            <div class="ai-follow-up-title">ğŸ’¬ ç»§ç»­è¿½é—®AI</div>
                            <div class="ai-input-container">
                                <textarea class="ai-input" id="aiInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œç»§ç»­ä¸AIå¯¹è¯... (æŒ‰Ctrl+Enterå‘é€)"
                                    rows="2" onkeydown="handleAIInputKeydown(event)"></textarea>
                                <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">å‘é€</button>
                            </div>
                            <div class="ai-conversation" id="aiConversation"></div>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <div class="actions-row">
                        <button class="btn btn-prev" id="prevBtn" onclick="previousQuestion()">ä¸Šä¸€é¢˜</button>
                        <button class="btn btn-submit" id="submitBtn" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
                        <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
                    </div>
                    <div class="record-actions">
                        <button class="btn btn-link" onclick="exportStateToFile()">ä¿å­˜è®°å½•</button>
                        <button class="btn btn-link" onclick="importStateFromFile()">è¯»å–è®°å½•</button>
                    </div>
                </div>
            </div>

            <!-- ç»“æœæ€»ç»“ -->
            <div id="resultSummary" class="result-summary" style="display: none;">
                <h2>è€ƒè¯•å®Œæˆï¼</h2>
                <div class="result-stats">
                    <p>æ€»é¢˜æ•°: <span id="finalTotalQuestions">0</span></p>
                    <p>ç­”å¯¹: <span id="finalCorrectCount">0</span></p>
                    <p>ç­”é”™: <span id="finalIncorrectCount">0</span></p>
                    <p>æ­£ç¡®ç‡: <span id="finalAccuracy">0%</span></p>
                </div>
                <button onclick="restartExam()" class="btn btn-primary">é‡æ–°å¼€å§‹</button>
            </div>

            <!-- Toast é€šçŸ¥ç³»ç»Ÿ -->
            <div id="toastContainer" class="toast-container"></div>
        </div>

        <!-- é¢˜ç›®å¯¼èˆªåˆ—è¡¨ -->
        <div id="questionNav" class="question-nav">
            <h3>é¢˜ç›®å¯¼èˆª</h3>

            <!-- éšæœºè€ƒè¯•æŒ‰é’® -->
            <button class="random-exam-btn-nav" onclick="startRandomExam()">
                ğŸ¯ éšæœºè€ƒè¯• (10é¢˜)
            </button>

            <!-- é”™é¢˜ç»„åŒºåŸŸ -->
            <div id="wrongQuestionsSection" class="wrong-questions-section" style="display: none;">
                <div class="wrong-questions-header">
                    <span class="wrong-questions-title">é”™é¢˜ç»Ÿè®¡</span>
                    <span class="wrong-count" id="wrongCount">0</span>
                </div>
                <button class="retry-wrong-btn" id="retryWrongBtn" onclick="retryWrongQuestions()" disabled>
                    é‡ç­”é”™é¢˜
                </button>
            </div>

            <div id="questionList" class="question-list"></div>
        </div>

        <!-- å¯¼èˆªé®ç½©å±‚ -->
        <div id="navOverlay" class="nav-overlay" onclick="closeMobileNav()"></div>

        <!-- å¯¼èˆªæŠ˜å æŒ‰é’® -->
        <button id="navToggleBtn" class="nav-toggle-btn" onclick="toggleNav()" title="æ˜¾ç¤º/éšè—é¢˜ç›®å¯¼èˆª">
            <!-- å›¾æ ‡å°†ç”±JavaScriptåŠ¨æ€è®¾ç½® -->
        </button>

        <!-- éšæœºè€ƒè¯•å¼¹çª— -->
        <div id="randomExamModal" class="random-exam-modal">
            <div class="random-exam-content">
                <div class="random-exam-header">
                    <h3>ğŸ¯ éšæœºè€ƒè¯•</h3>
                    <div class="random-exam-info">
                        <span>é¢˜ç›®æ•°é‡: 10é¢˜</span>
                        <span>æ¯é¢˜åˆ†å€¼: 10åˆ†</span>
                        <span>æ€»åˆ†: 100åˆ†</span>
                    </div>
                </div>
                <div class="random-exam-body" id="randomExamBody">
                    <!-- é¢˜ç›®å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="random-exam-footer">
                    <div class="random-exam-progress" id="randomExamProgress">
                        å·²ç­”é¢˜: 0/10
                    </div>
                    <div class="random-exam-buttons">
                        <button class="random-exam-btn secondary" onclick="closeRandomExam()">å…³é—­</button>
                        <button class="random-exam-btn primary" id="submitRandomExamBtn" onclick="submitRandomExam()"
                            disabled>æäº¤è¯•å·</button>
                    </div>
                    <div class="random-exam-actions" style="display: none;">
                        <button class="random-exam-btn secondary" onclick="exportStateToFile()">ä¿å­˜è®°å½•</button>
                        <button class="random-exam-btn secondary" onclick="importStateFromFile()">è¯»å–è®°å½•</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let examData = [];
            let currentQuestionIndex = 0;
            let selectedAnswer = []; // æ”¹ä¸ºæ•°ç»„ä»¥æ”¯æŒå¤šé€‰
            let correctCount = 0;
            let incorrectCount = 0;
            let answeredQuestions = new Set();

            // ä¿å­˜è€ƒè¯•çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
            function saveExamState() {
                const examState = {
                    currentQuestionIndex: currentQuestionIndex,
                    correctCount: correctCount,
                    incorrectCount: incorrectCount,
                    answeredQuestions: Array.from(answeredQuestions),
                    examData: examData.map(question => ({
                        ...question,
                        userAnswer: question.userAnswer ? [...question.userAnswer] : null,
                        wrongCount: question.wrongCount || 0
                    }))
                };

                try {
                    localStorage.setItem('examState', JSON.stringify(examState));
                } catch (error) {
                    console.error('ä¿å­˜è€ƒè¯•çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // ä»æœ¬åœ°å­˜å‚¨æ¢å¤è€ƒè¯•çŠ¶æ€
            function loadExamState() {
                const savedState = localStorage.getItem('examState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);

                        // æ¢å¤åŸºæœ¬çŠ¶æ€
                        currentQuestionIndex = state.currentQuestionIndex || 0;
                        correctCount = state.correctCount || 0;
                        incorrectCount = state.incorrectCount || 0;
                        answeredQuestions = new Set(state.answeredQuestions || []);

                        // æ¢å¤ç”¨æˆ·ç­”æ¡ˆåˆ°examData
                        if (state.examData && state.examData.length > 0) {
                            state.examData.forEach((savedQuestion, index) => {
                                if (savedQuestion.userAnswer && examData[index]) {
                                    examData[index].userAnswer = [...savedQuestion.userAnswer];
                                }
                                // æ¢å¤å·²ä¿å­˜çš„ AI è§£æå†…å®¹
                                if (typeof savedQuestion.aiAnalysisHtml === 'string' && examData[index]) {
                                    examData[index].aiAnalysisHtml = savedQuestion.aiAnalysisHtml;
                                }
                                // æ¢å¤AIå¯¹è¯å†å²
                                if (savedQuestion.aiConversation && Array.isArray(savedQuestion.aiConversation) && examData[index]) {
                                    examData[index].aiConversation = [...savedQuestion.aiConversation];
                                }
                                // æ¢å¤ç­”é”™æ¬¡æ•°
                                if (typeof savedQuestion.wrongCount === 'number' && examData[index]) {
                                    examData[index].wrongCount = savedQuestion.wrongCount;
                                }
                            });
                        }

                        // æ¢å¤å½“å‰é¢˜ç›®çš„é€‰æ‹©çŠ¶æ€
                        if (examData[currentQuestionIndex] && examData[currentQuestionIndex].userAnswer) {
                            selectedAnswer = [...examData[currentQuestionIndex].userAnswer];
                        } else {
                            selectedAnswer = [];
                        }

                        return true;
                    } catch (error) {
                        console.error('æ¢å¤è€ƒè¯•çŠ¶æ€å¤±è´¥:', error);
                        localStorage.removeItem('examState');
                        return false;
                    }
                }
                return false;
            }

            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„è€ƒè¯•çŠ¶æ€
            function clearExamState() {
                localStorage.removeItem('examState');
                showToast('è€ƒè¯•å†å²å·²æ¸…é™¤ï¼', 'info');
                // é‡æ–°åˆå§‹åŒ–è€ƒè¯•ä»¥æ˜¾ç¤ºæ–°çš„çŠ¶æ€
                currentQuestionIndex = 0;
                correctCount = 0;
                incorrectCount = 0;
                answeredQuestions.clear();
                selectedAnswer = [];

                // æ¸…é™¤æ‰€æœ‰é¢˜ç›®çš„ç­”é”™æ¬¡æ•°
                examData.forEach(question => {
                    delete question.wrongCount;
                });

                initializeExam();
            }

            // åŠ è½½é¢˜åº“æ•°æ®
            async function loadExamData() {
                try {
                    const response = await fetch('exam.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    examData = await response.json();

                    // å°è¯•æ¢å¤ä¹‹å‰çš„è€ƒè¯•çŠ¶æ€
                    const hasRestoredState = loadExamState();

                    if (hasRestoredState) {
                        // ç›´æ¥æ¢å¤è€ƒè¯•çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºç¡®è®¤æç¤º
                        initializeExam();
                    } else {
                        // æ²¡æœ‰å†å²è®°å½•ï¼Œé‡æ–°å¼€å§‹
                        initializeExam();
                    }
                } catch (error) {
                    console.error('åŠ è½½é¢˜åº“å¤±è´¥:', error);
                    showToast('åŠ è½½é¢˜åº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥exam.jsonæ–‡ä»¶æ˜¯å¦å­˜åœ¨', 'error');
                }
            }

            // åˆå§‹åŒ–è€ƒè¯•
            function initializeExam() {
                if (examData.length === 0) return;

                updateStats();
                displayQuestion();
                updateButtons();
                generateQuestionNav();
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            function updateStats() {
                document.getElementById('totalQuestions').textContent = examData.length;
                document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
                document.getElementById('correctCount').textContent = correctCount;
                document.getElementById('incorrectCount').textContent = incorrectCount;

                const progress = ((currentQuestionIndex + 1) / examData.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';

                // æ›´æ–°é¢˜ç›®å¯¼èˆªçŠ¶æ€
                updateQuestionNavStatus();
            }

            // ç”Ÿæˆé¢˜ç›®å¯¼èˆªåˆ—è¡¨
            function generateQuestionNav() {
                const questionList = document.getElementById('questionList');
                questionList.innerHTML = '';

                examData.forEach((question, index) => {
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    questionItem.textContent = question.num;
                    questionItem.onclick = () => jumpToQuestion(index);
                    questionList.appendChild(questionItem);
                });

                updateQuestionNavStatus();
            }

            // æ›´æ–°é¢˜ç›®å¯¼èˆªçŠ¶æ€
            function updateQuestionNavStatus() {
                const questionItems = document.querySelectorAll('.question-item');
                let wrongCount = 0;

                questionItems.forEach((item) => {
                    // ä»é¢˜ç›®ç¼–å·è·å–ç´¢å¼•
                    const questionNum = parseInt(item.textContent);
                    const questionIndex = examData.findIndex(q => q.num === questionNum);

                    if (questionIndex === -1) return;

                    item.classList.remove('current', 'correct', 'incorrect', 'unanswered');

                    if (questionIndex === currentQuestionIndex) {
                        item.classList.add('current');
                    } else if (answeredQuestions.has(questionIndex)) {
                        const question = examData[questionIndex];
                        const userAnswer = question.userAnswer || [];
                        const isCorrect = question.answerList.length === userAnswer.length &&
                            question.answerList.every(ans => userAnswer.includes(ans)) &&
                            userAnswer.every(ans => question.answerList.includes(ans));

                        if (isCorrect) {
                            item.classList.add('correct');
                        } else {
                            item.classList.add('incorrect');
                            wrongCount++;
                        }
                    } else {
                        item.classList.add('unanswered');
                    }
                });

                // æ›´æ–°é”™é¢˜åŒºåŸŸ
                updateWrongQuestionsSection(wrongCount);
            }

            // æ›´æ–°é”™é¢˜åŒºåŸŸæ˜¾ç¤º
            function updateWrongQuestionsSection(wrongCount) {
                const wrongSection = document.getElementById('wrongQuestionsSection');
                const wrongCountElement = document.getElementById('wrongCount');
                const retryBtn = document.getElementById('retryWrongBtn');

                if (wrongCount > 0) {
                    wrongSection.style.display = 'block';
                    wrongCountElement.textContent = wrongCount;
                    retryBtn.disabled = false;
                } else {
                    wrongSection.style.display = 'none';
                    retryBtn.disabled = true;
                }
            }

            // è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®
            function jumpToQuestion(index) {
                if (index >= 0 && index < examData.length) {
                    currentQuestionIndex = index;
                    displayQuestion();
                    updateStats();
                    updateButtons();
                    saveExamState();
                }
            }

            // æ˜¾ç¤ºå½“å‰é¢˜ç›®
            function displayQuestion() {
                if (currentQuestionIndex >= examData.length) return;

                const question = examData[currentQuestionIndex];

                // é‡ç½®é€‰æ‹©çŠ¶æ€ - å…ˆæ¸…ç©ºselectedAnswerï¼Œå†æ ¹æ®æ˜¯å¦å·²å›ç­”æ¥å†³å®š
                if (answeredQuestions.has(currentQuestionIndex)) {
                    // å¦‚æœå·²ç»å›ç­”è¿‡ï¼Œä»examDataä¸­è·å–ç”¨æˆ·çš„é€‰æ‹©
                    selectedAnswer = question.userAnswer ? [...question.userAnswer] : [];
                } else {
                    // å¦‚æœæœªå›ç­”è¿‡ï¼Œæ¸…ç©ºé€‰æ‹©
                    selectedAnswer = [];
                }

                // é‡ç½®AIè§£æçŠ¶æ€
                const aiAnalysis = document.getElementById('aiAnalysis');
                const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
                const questionContainer = document.getElementById('questionContainer');
                const aiFollowUp = document.getElementById('aiFollowUp');
                aiAnalysis.style.display = 'none';
                aiAnalysis.classList.remove('show');
                aiAnalysisBtn.textContent = 'ğŸ¤– AIè§£æ';
                delete aiAnalysis.dataset.generated;
                // éšè—è¿½é—®åŒºåŸŸ
                aiFollowUp.style.display = 'none';

                // ç§»é™¤æ»šåŠ¨æ¡
                questionContainer.classList.remove('scrollable');

                document.getElementById('questionType').textContent = question.typeName;
                document.getElementById('questionNumber').textContent = `ç¬¬ ${question.num} é¢˜`;
                document.getElementById('questionText').textContent = question.topic;

                // æ˜¾ç¤ºé€‰é¡¹
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = '';

                // æ¸…é™¤ç­”æ¡ˆæ˜¾ç¤ºå’Œæ‰€æœ‰é€‰é¡¹æ ·å¼
                document.getElementById('answerDisplay').classList.remove('show');

                // å¤„ç† optionMap æ•°ç»„ç»“æ„
                if (Array.isArray(question.optionMap)) {
                    // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆåŒ…å«é€‰é¡¹çš„å¯¹è±¡ï¼‰
                    const options = question.optionMap[0];
                    Object.entries(options).forEach(([key, value]) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option';
                        optionDiv.onclick = (event) => selectOption(key, event);

                        const input = document.createElement('input');
                        // æ ¹æ®é¢˜ç›®ç±»å‹è®¾ç½®inputç±»å‹
                        if (question.typeName === 'å¤šé€‰é¢˜') {
                            input.type = 'checkbox';
                            input.name = 'option';
                        } else {
                            // åˆ¤æ–­é¢˜å’Œå•é€‰é¢˜ä½¿ç”¨radio
                            input.type = 'radio';
                            input.name = 'option';
                        }
                        input.value = key;
                        input.checked = selectedAnswer.includes(key); // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­

                        const label = document.createElement('span');
                        label.textContent = `${key}. ${value}`;

                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        optionsContainer.appendChild(optionDiv);
                    });
                } else {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œç›´æ¥å¤„ç†
                    Object.entries(question.optionMap).forEach(([key, value]) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option';
                        optionDiv.onclick = (event) => selectOption(key, event);

                        const input = document.createElement('input');
                        // æ ¹æ®é¢˜ç›®ç±»å‹è®¾ç½®inputç±»å‹
                        if (question.typeName === 'å¤šé€‰é¢˜') {
                            input.type = 'checkbox';
                            input.name = 'option';
                        } else {
                            // åˆ¤æ–­é¢˜å’Œå•é€‰é¢˜ä½¿ç”¨radio
                            input.type = 'radio';
                            input.name = 'option';
                        }
                        input.value = key;
                        input.checked = selectedAnswer.includes(key); // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­

                        const label = document.createElement('span');
                        label.textContent = `${key}. ${value}`;

                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        optionsContainer.appendChild(optionDiv);
                    });
                }

                // å¦‚æœå·²ç»å›ç­”è¿‡ï¼Œæ˜¾ç¤ºä¹‹å‰çš„ç­”æ¡ˆå’Œæ ·å¼
                if (answeredQuestions.has(currentQuestionIndex)) {
                    const isCorrect = question.answerList.length === selectedAnswer.length &&
                        question.answerList.every(ans => selectedAnswer.includes(ans)) &&
                        selectedAnswer.every(ans => question.answerList.includes(ans));
                    showAnswer(isCorrect);
                }
            }

            // é€‰æ‹©é€‰é¡¹
            function selectOption(option, event) {
                const input = event.currentTarget.querySelector('input');
                const question = examData[currentQuestionIndex];

                if (question.typeName === 'å¤šé€‰é¢˜') {
                    // å¤šé€‰é¢˜ï¼šå¯ä»¥å¤šé€‰
                    if (input.checked) {
                        // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
                        selectedAnswer = selectedAnswer.filter(ans => ans !== option);
                        input.checked = false;
                    } else {
                        // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™é€‰ä¸­
                        selectedAnswer.push(option);
                        input.checked = true;
                    }
                } else {
                    // åˆ¤æ–­é¢˜å’Œå•é€‰é¢˜ï¼šåªèƒ½å•é€‰
                    selectedAnswer = [option];
                    // æ›´æ–°æ‰€æœ‰radioæŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('input[name="option"]').forEach(radio => {
                        radio.checked = radio.value === option;
                    });
                }

                // æ›´æ–°é€‰é¡¹æ ·å¼
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // ä¸ºæ‰€æœ‰é€‰ä¸­çš„é€‰é¡¹æ·»åŠ selectedæ ·å¼
                selectedAnswer.forEach(ans => {
                    const optionDiv = document.querySelector(`input[value="${ans}"]`).closest('.option');
                    if (optionDiv) {
                        optionDiv.classList.add('selected');
                    }
                });
            }

            // æäº¤ç­”æ¡ˆ
            function submitAnswer() {
                if (selectedAnswer.length === 0) {
                    showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆï¼', 'warning');
                    return;
                }

                const question = examData[currentQuestionIndex];
                const isCorrect = question.answerList.length === selectedAnswer.length &&
                    question.answerList.every(ans => selectedAnswer.includes(ans)) &&
                    selectedAnswer.every(ans => question.answerList.includes(ans));

                if (isCorrect) {
                    if (!answeredQuestions.has(currentQuestionIndex)) {
                        correctCount++;
                    }
                } else {
                    if (!answeredQuestions.has(currentQuestionIndex)) {
                        incorrectCount++;
                    }
                    // è®°å½•ç­”é”™æ¬¡æ•°
                    if (!question.wrongCount) {
                        question.wrongCount = 0;
                    }
                    question.wrongCount++;
                }

                // ä¿å­˜ç”¨æˆ·çš„ç­”æ¡ˆ
                question.userAnswer = selectedAnswer;
                answeredQuestions.add(currentQuestionIndex);
                showAnswer(isCorrect);
                updateStats();
                updateButtons();

                // ä¿å­˜è€ƒè¯•çŠ¶æ€
                saveExamState();
            }

            // æ˜¾ç¤ºç­”æ¡ˆ
            function showAnswer(isCorrect) {
                const answerDisplay = document.getElementById('answerDisplay');
                const answerText = document.getElementById('answerText');
                const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
                const question = examData[currentQuestionIndex];

                if (isCorrect) {
                    answerText.textContent = `âœ… å›ç­”æ­£ç¡®ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${question.answerList.join('ã€')}`;
                } else {
                    answerText.textContent = `âŒ å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${question.answerList.join('ã€')}`;
                }

                answerDisplay.classList.add('show');

                // æ˜¾ç¤ºAIè§£ææŒ‰é’®
                aiAnalysisBtn.style.display = 'inline-flex';

                // æ›´æ–°é€‰é¡¹æ ·å¼
                document.querySelectorAll('.option').forEach((opt, index) => {
                    let optionKey;
                    if (Array.isArray(question.optionMap)) {
                        // å¦‚æœæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå…ƒç´ 
                        optionKey = Object.keys(question.optionMap[0])[index];
                    } else {
                        // å¦‚æœæ˜¯å¯¹è±¡ï¼Œç›´æ¥å–é”®
                        optionKey = Object.keys(question.optionMap)[index];
                    }

                    if (question.answerList.includes(optionKey)) {
                        opt.classList.add('correct');
                    } else if (opt.querySelector('input').checked) {
                        opt.classList.add('incorrect');
                    }
                });
            }

            // ä¸Šä¸€é¢˜
            function previousQuestion() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayQuestion();
                    updateStats();
                    updateButtons();

                    // ä¿å­˜è€ƒè¯•çŠ¶æ€
                    saveExamState();
                }
            }

            // ä¸‹ä¸€é¢˜
            function nextQuestion() {
                // å¦‚æœå½“å‰é¢˜ç›®æœªå›ç­”ä½†æœ‰é€‰æ‹©ï¼Œè‡ªåŠ¨æäº¤
                if (!answeredQuestions.has(currentQuestionIndex) && selectedAnswer.length > 0) {
                    // è‡ªåŠ¨æäº¤ç­”æ¡ˆ
                    const question = examData[currentQuestionIndex];
                    const isCorrect = question.answerList.length === selectedAnswer.length &&
                        question.answerList.every(ans => selectedAnswer.includes(ans)) &&
                        selectedAnswer.every(ans => question.answerList.includes(ans));

                    if (isCorrect) {
                        correctCount++;
                        showToast(`ç¬¬${question.num}é¢˜è‡ªåŠ¨æäº¤ï¼šå›ç­”æ­£ç¡®ï¼`, 'success');
                    } else {
                        incorrectCount++;
                        // è®°å½•ç­”é”™æ¬¡æ•°
                        if (!question.wrongCount) {
                            question.wrongCount = 0;
                        }
                        question.wrongCount++;
                        showToast(`ç¬¬${question.num}é¢˜è‡ªåŠ¨æäº¤ï¼šå›ç­”é”™è¯¯ï¼`, 'error');
                    }

                    // è®°å½•ç­”æ¡ˆ
                    question.userAnswer = [...selectedAnswer];
                    answeredQuestions.add(currentQuestionIndex);

                    // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    showAnswer(isCorrect);

                    // ä¿å­˜çŠ¶æ€
                    saveExamState();
                }

                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªå›ç­”çš„é¢˜ç›®
                let nextUnansweredIndex = -1;
                for (let i = currentQuestionIndex + 1; i < examData.length; i++) {
                    if (!answeredQuestions.has(i)) {
                        nextUnansweredIndex = i;
                        break;
                    }
                }

                // å¦‚æœåé¢æ²¡æœ‰æœªå›ç­”çš„é¢˜ç›®ï¼Œä»å¼€å¤´æŸ¥æ‰¾
                if (nextUnansweredIndex === -1) {
                    for (let i = 0; i < currentQuestionIndex; i++) {
                        if (!answeredQuestions.has(i)) {
                            nextUnansweredIndex = i;
                            break;
                        }
                    }
                }

                // å¦‚æœæ‰¾åˆ°äº†æœªå›ç­”çš„é¢˜ç›®ï¼Œè·³è½¬è¿‡å»
                if (nextUnansweredIndex !== -1) {
                    currentQuestionIndex = nextUnansweredIndex;
                    displayQuestion();
                    updateStats();
                    updateButtons();
                    saveExamState();
                    showToast(`å·²è·³è½¬åˆ°ç¬¬ ${examData[currentQuestionIndex].num} é¢˜ï¼ˆæœªå›ç­”ï¼‰`, 'info');
                } else {
                    // æ‰€æœ‰é¢˜ç›®éƒ½å·²å›ç­”ï¼Œæ˜¾ç¤ºç»“æœ
                    showResult();
                }
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            function updateButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const submitBtn = document.getElementById('submitBtn');

                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.disabled = currentQuestionIndex === examData.length - 1;
                submitBtn.disabled = answeredQuestions.has(currentQuestionIndex);
            }

            // æ˜¾ç¤ºç»“æœ
            function showResult() {
                document.getElementById('questionContainer').style.display = 'none';
                document.getElementById('resultSummary').classList.add('show');

                const score = Math.round((correctCount / examData.length) * 100);
                document.getElementById('scoreDisplay').textContent = score + 'åˆ†';
            }

            // é‡æ–°å¼€å§‹è€ƒè¯•
            function restartExam() {
                currentQuestionIndex = 0;
                correctCount = 0;
                incorrectCount = 0;
                answeredQuestions.clear();
                selectedAnswer = [];

                // æ¸…é™¤æ‰€æœ‰é¢˜ç›®çš„ç”¨æˆ·ç­”æ¡ˆï¼ˆä¿ç•™ç­”é”™æ¬¡æ•°ï¼‰
                examData.forEach(question => {
                    delete question.userAnswer;
                    // æ³¨æ„ï¼šä¸åˆ é™¤ wrongCountï¼Œä¿ç•™å†å²ç­”é”™æ¬¡æ•°
                });

                clearExamState();
                document.getElementById('resultSummary').style.display = 'none';
                document.getElementById('questionContainer').style.display = 'block';
                initializeExam();
            }

            // é‡ç­”é”™é¢˜
            function retryWrongQuestions() {
                // æ”¶é›†æ‰€æœ‰é”™é¢˜ç´¢å¼•
                const wrongQuestionIndexes = [];
                examData.forEach((question, index) => {
                    if (answeredQuestions.has(index)) {
                        const userAnswer = question.userAnswer || [];
                        const isCorrect = question.answerList.length === userAnswer.length &&
                            question.answerList.every(ans => userAnswer.includes(ans)) &&
                            userAnswer.every(ans => question.answerList.includes(ans));

                        if (!isCorrect) {
                            wrongQuestionIndexes.push(index);
                        }
                    }
                });

                if (wrongQuestionIndexes.length === 0) {
                    showToast('æ²¡æœ‰é”™é¢˜éœ€è¦é‡ç­”', 'info');
                    return;
                }

                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                showConfirmToast(
                    `ç¡®å®šè¦é‡ç­” ${wrongQuestionIndexes.length} é“é”™é¢˜å—ï¼Ÿè¿™å°†æ¸…é™¤è¿™äº›é¢˜ç›®çš„ç­”æ¡ˆè®°å½•ã€‚`,
                    () => {
                        // æ¸…é™¤é”™é¢˜çš„ç­”æ¡ˆè®°å½•ï¼ˆä¿ç•™ç­”é”™æ¬¡æ•°ï¼‰
                        wrongQuestionIndexes.forEach(index => {
                            delete examData[index].userAnswer;
                            answeredQuestions.delete(index);
                            // æ³¨æ„ï¼šä¸åˆ é™¤ wrongCountï¼Œä¿ç•™å†å²ç­”é”™æ¬¡æ•°
                        });

                        // é‡æ–°è®¡ç®—ç»Ÿè®¡
                        correctCount = 0;
                        incorrectCount = 0;
                        examData.forEach((question, index) => {
                            if (answeredQuestions.has(index)) {
                                const userAnswer = question.userAnswer || [];
                                const isCorrect = question.answerList.length === userAnswer.length &&
                                    question.answerList.every(ans => userAnswer.includes(ans)) &&
                                    userAnswer.every(ans => question.answerList.includes(ans));

                                if (isCorrect) {
                                    correctCount++;
                                } else {
                                    incorrectCount++;
                                }
                            }
                        });

                        // è·³è½¬åˆ°ç¬¬ä¸€ä¸ªé”™é¢˜
                        currentQuestionIndex = wrongQuestionIndexes[0];
                        selectedAnswer = [];

                        // ä¿å­˜çŠ¶æ€å¹¶æ›´æ–°ç•Œé¢
                        saveExamState();
                        updateStats();
                        displayQuestion();
                        updateButtons();
                        showToast(`å·²è·³è½¬åˆ°ç¬¬ ${examData[currentQuestionIndex].num} é¢˜ï¼ˆé”™é¢˜é‡ç­”ï¼‰`, 'success');
                    },
                    () => {
                        showToast('å·²å–æ¶ˆé‡ç­”é”™é¢˜', 'info');
                    }
                );
            }

            // Toast é€šçŸ¥ç³»ç»Ÿ
            function showToast(message, type = 'info', duration = 3000) {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;

                toastContainer.appendChild(toast);

                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†çš„ Toast ç‰ˆæœ¬
            function showConfirmToast(message, onConfirm, onCancel) {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = 'toast info';
                toast.style.pointerEvents = 'auto';
                toast.style.maxWidth = '400px';

                // åˆ›å»ºæŒ‰é’®å…ƒç´ 
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.style.cssText = 'background: #6c757d; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;';
                cancelBtn.onclick = () => {
                    toast.remove();
                    if (onCancel) onCancel();
                };

                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'ç¡®å®š';
                confirmBtn.style.cssText = 'background: #007bff; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;';
                confirmBtn.onclick = () => {
                    toast.remove();
                    if (onConfirm) onConfirm();
                };

                // è®¾ç½®toastå†…å®¹
                toast.innerHTML = `<div style="margin-bottom: 10px;">${message}</div>`;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(confirmBtn);

                toast.appendChild(buttonContainer);

                toastContainer.appendChild(toast);

                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                // è‡ªåŠ¨éšè—ï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰ç‚¹å‡»æŒ‰é’®ï¼‰
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                        }, 300);
                    }
                }, 10000); // 10ç§’åè‡ªåŠ¨éšè—
            }

            // AIè§£æç›¸å…³å‡½æ•°
            async function exportStateToFile() {
                try {
                    // å…ˆä¿å­˜æœ€æ–°çŠ¶æ€åˆ° localStorage
                    saveExamState();
                    const stateStr = localStorage.getItem('examState');
                    const content = stateStr || JSON.stringify({
                        currentQuestionIndex,
                        correctCount,
                        incorrectCount,
                        answeredQuestions: Array.from(answeredQuestions),
                        examData: examData.map(q => ({
                            ...q,
                            userAnswer: q.userAnswer ? [...q.userAnswer] : null,
                            aiAnalysisHtml: typeof q.aiAnalysisHtml === 'string' ? q.aiAnalysisHtml : undefined
                        }))
                    }, null, 2);

                    const blob = new Blob([content], { type: 'application/json' });

                    // ä¼˜å…ˆå°è¯• File System Access API ä»¥â€œæŒ‡å®šä½ç½®â€ä¿å­˜
                    if (window.showSaveFilePicker) {
                        try {
                            const handle = await window.showSaveFilePicker({
                                suggestedName: 'exam_state.json',
                                types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                            });
                            const writable = await handle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            showToast('è®°å½•å·²ä¿å­˜åˆ°æŒ‡å®šä½ç½®', 'success');
                            return;
                        } catch (err) {
                            // ç”¨æˆ·å–æ¶ˆæˆ–ä¸æ”¯æŒåˆ™å›é€€ä¸‹è½½
                        }
                    }

                    // å›é€€ï¼šè§¦å‘æµè§ˆå™¨ä¸‹è½½
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'exam_state.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('è®°å½•å·²ä¸‹è½½ä¸º exam_state.json', 'success');
                } catch (error) {
                    console.error('å¯¼å‡ºè®°å½•å¤±è´¥:', error);
                    showToast('å¯¼å‡ºè®°å½•å¤±è´¥', 'error');
                }
            }

            async function importStateFromFile() {
                try {
                    let file;
                    // ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ APIï¼ˆæ›´ä¸€è‡´çš„ä½“éªŒï¼‰
                    if (window.showOpenFilePicker) {
                        const [handle] = await window.showOpenFilePicker({
                            multiple: false,
                            types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                        });
                        const f = await handle.getFile();
                        file = f;
                    } else {
                        // å›é€€ï¼šåˆ›å»ºéšè— input é€‰æ‹©æ–‡ä»¶
                        file = await new Promise((resolve, reject) => {
                            const input = document.createElement('input');
                            input.type = 'file';
                            input.accept = 'application/json,.json';
                            input.style.display = 'none';
                            document.body.appendChild(input);
                            input.addEventListener('change', () => {
                                const f = input.files && input.files[0];
                                document.body.removeChild(input);
                                f ? resolve(f) : reject(new Error('æœªé€‰æ‹©æ–‡ä»¶'));
                            });
                            input.click();
                        });
                    }

                    const text = await file.text();
                    const imported = JSON.parse(text);

                    // åŸºæœ¬æ ¡éªŒ
                    if (!imported || typeof imported !== 'object' || !('examData' in imported)) {
                        showToast('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                        return;
                    }

                    // å†™å…¥æœ¬åœ°å­˜å‚¨å¹¶æ¢å¤
                    localStorage.setItem('examState', JSON.stringify(imported));

                    // è¦†ç›–å½“å‰å†…å­˜çŠ¶æ€
                    currentQuestionIndex = 0;
                    correctCount = 0;
                    incorrectCount = 0;
                    answeredQuestions = new Set();
                    selectedAnswer = [];

                    // é‡æ–°åŠ è½½é¢˜åº“ä»¥ä¾¿ç»“æ„ä¸€è‡´ï¼Œç„¶åä»æœ¬åœ°çŠ¶æ€æ¢å¤
                    // è‹¥é¢˜åº“æœ¬èº«ä¸€è‡´ï¼Œåˆ™ loadExamState ä¼šå°† userAnswer/aiAnalysisHtml åˆå¹¶å› examData
                    const hasRestored = loadExamState();
                    if (!hasRestored) {
                        showToast('è¯»å–è®°å½•å¤±è´¥ï¼šæ— æ³•æ¢å¤çŠ¶æ€', 'error');
                        return;
                    }

                    initializeExam();
                    showToast('è®°å½•å·²è¯»å–å¹¶è¦†ç›–å½“å‰æ•°æ®', 'success');
                } catch (error) {
                    console.error('å¯¼å…¥è®°å½•å¤±è´¥:', error);
                    showToast('è¯»å–è®°å½•å¤±è´¥', 'error');
                }
            }
            function toggleAIAnalysis() {
                const aiAnalysis = document.getElementById('aiAnalysis');
                const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
                const questionContainer = document.getElementById('questionContainer');
                const aiAnalysisContent = document.getElementById('aiAnalysisContent');

                if (aiAnalysis.style.display === 'none') {
                    // æ˜¾ç¤ºAIè§£æ
                    aiAnalysis.style.display = 'block';
                    aiAnalysis.classList.add('show');
                    aiAnalysisBtn.textContent = 'ğŸ¤– éšè—AIè§£æ';
                    aiAnalysisBtn.style.display = 'block'; // ç¡®ä¿æŒ‰é’®å¯è§

                    // ä¿æŒç­”é¢˜çª—å£ä¸å‡ºç°ç«–å‘æ»šåŠ¨æ¡ï¼ˆä»…AIè§£æåŒºåŸŸå¯æ»šåŠ¨ï¼‰

                    // ä¼˜å…ˆä½¿ç”¨å·²ä¿å­˜çš„è§£æå†…å®¹
                    const savedHtml = examData[currentQuestionIndex] && examData[currentQuestionIndex].aiAnalysisHtml;
                    if (typeof savedHtml === 'string' && savedHtml.length > 0) {
                        aiAnalysisContent.innerHTML = savedHtml;
                        aiAnalysis.dataset.generated = 'true';

                        // æ˜¾ç¤ºè¿½é—®åŒºåŸŸå’Œå¯¹è¯å†å²
                        document.getElementById('aiFollowUp').style.display = 'block';
                        displayAIConversation();
                    } else {
                        // å¦‚æœè¿˜æ²¡æœ‰ç”Ÿæˆè¿‡è§£æï¼Œåˆ™ç”Ÿæˆ
                        if (!aiAnalysis.dataset.generated) {
                            // ç¡®ä¿è¿½é—®åŒºåŸŸéšè—
                            document.getElementById('aiFollowUp').style.display = 'none';
                            generateAIAnalysis();
                        }
                    }

                    // å–æ¶ˆè‡ªåŠ¨æ»šåŠ¨ï¼Œé˜²æ­¢æŒ‰é’®åŒºåŸŸä½ç½®å˜åŒ–
                } else {
                    // éšè—AIè§£æ
                    aiAnalysis.style.display = 'none';
                    aiAnalysis.classList.remove('show');
                    aiAnalysisBtn.textContent = 'ğŸ¤– AIè§£æ';
                    aiAnalysisBtn.style.display = 'inline-flex'; // éšè—åç»§ç»­æ˜¾ç¤ºæŒ‰é’®ï¼Œä¾¿äºå†æ¬¡æ‰“å¼€
                    // éšè—è¿½é—®åŒºåŸŸ
                    document.getElementById('aiFollowUp').style.display = 'none';
                    // ç­”é¢˜çª—å£ä¿æŒä¸æ»šåŠ¨
                }
            }

            async function generateAIAnalysis() {
                const question = examData[currentQuestionIndex];
                const aiAnalysisContent = document.getElementById('aiAnalysisContent');
                const aiAnalysis = document.getElementById('aiAnalysis');

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                aiAnalysisContent.innerHTML = `
                    <div class="loading">
                        <div class="ai-loading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">æ­£åœ¨ç”ŸæˆAIè§£æ...</div>
                        </div>
                    </div>
                `;

                try {
                    // æ„å»ºè¯·æ±‚æ•°æ®
                    const requestData = {
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "system",
                                content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•è¾…å¯¼è€å¸ˆï¼Œè¯·å¯¹ä»¥ä¸‹é¢˜ç›®è¿›è¡Œè¯¦ç»†è§£æï¼ŒåŒ…æ‹¬ï¼š1. é¢˜ç›®ç±»å‹åˆ†æ 2. å…³é”®æ¦‚å¿µè§£é‡Š 3. è§£é¢˜æ€è·¯ 4. æ­£ç¡®ç­”æ¡ˆåˆ†æ 5. ç›¸å…³çŸ¥è¯†ç‚¹æ‰©å±•ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œè¯­è¨€è¦é€šä¿—æ˜“æ‡‚ã€‚"
                            },
                            {
                                role: "user",
                                content: `é¢˜ç›®ï¼š${question.topic}\n\né¢˜ç›®ç±»å‹ï¼š${question.typeName}\n\né€‰é¡¹ï¼š${JSON.stringify(question.optionMap)}\n\næ­£ç¡®ç­”æ¡ˆï¼š${question.answerList.join('ã€')}\n\nè¯·å¯¹è¿™é“é¢˜è¿›è¡Œè¯¦ç»†è§£æã€‚`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    };

                    // è°ƒç”¨DeepSeek API
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-0892a660de854b798ebe659c0e800875'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const aiResponse = data.choices[0].message.content;

                        // æ ¼å¼åŒ–AIå“åº”
                        const formattedResponse = aiResponse
                            .split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                if (line.startsWith('1.') || line.startsWith('2.') || line.startsWith('3.') || line.startsWith('4.') || line.startsWith('5.')) {
                                    return `<h5 style="color: #007bff; margin: 15px 0 8px 0;">${line}</h5>`;
                                } else if (line.startsWith('â€¢') || line.startsWith('-')) {
                                    return `<div style="margin: 8px 0; padding-left: 20px;">${line}</div>`;
                                } else {
                                    return `<p style="margin: 8px 0;">${line}</p>`;
                                }
                            })
                            .join('');

                        aiAnalysisContent.innerHTML = formattedResponse;

                        // æ ‡è®°ä¸ºå·²ç”Ÿæˆ
                        aiAnalysis.dataset.generated = 'true';

                        // ä¿å­˜åˆ°é¢˜ç›®å¯¹è±¡å¹¶æŒä¹…åŒ–ï¼Œä¾›ä¸‹æ¬¡ç›´æ¥ä½¿ç”¨
                        examData[currentQuestionIndex].aiAnalysisHtml = formattedResponse;

                        // æ˜¾ç¤ºè¿½é—®åŒºåŸŸ
                        document.getElementById('aiFollowUp').style.display = 'block';

                        // åˆå§‹åŒ–å¯¹è¯å†å²
                        if (!examData[currentQuestionIndex].aiConversation) {
                            examData[currentQuestionIndex].aiConversation = [];
                        }

                        saveExamState();
                        showToast('AIè§£æç”Ÿæˆå®Œæˆï¼', 'success');

                        // å–æ¶ˆè‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å…å½±å“æŒ‰é’®åŒºåŸŸä½ç½®
                    } else {
                        throw new Error('APIå“åº”æ ¼å¼é”™è¯¯');
                    }

                } catch (error) {
                    console.error('AIè§£æç”Ÿæˆå¤±è´¥:', error);
                    aiAnalysisContent.innerHTML = `
                        <div class="error">
                            <p>AIè§£æç”Ÿæˆå¤±è´¥</p>
                            <p style="font-size: 12px; color: #6c757d;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                            <button onclick="generateAIAnalysis()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">é‡è¯•</button>
                        </div>
                    `;
                    showToast('AIè§£æç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            }

            // å‘é€AIæ¶ˆæ¯
            async function sendAIMessage() {
                const aiInput = document.getElementById('aiInput');
                const aiSendBtn = document.getElementById('aiSendBtn');
                const aiConversation = document.getElementById('aiConversation');
                const message = aiInput.value.trim();

                if (!message) {
                    showToast('è¯·è¾“å…¥é—®é¢˜', 'warning');
                    return;
                }

                // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
                aiInput.disabled = true;
                aiSendBtn.disabled = true;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addAIMessage('user', message);
                aiInput.value = '';

                // æ·»åŠ åŠ è½½æ¶ˆæ¯
                const loadingId = addAIMessage('loading', 'AIæ­£åœ¨æ€è€ƒä¸­...');

                try {
                    const question = examData[currentQuestionIndex];

                    // æ„å»ºå¯¹è¯å†å²
                    const conversationHistory = examData[currentQuestionIndex].aiConversation || [];
                    const messages = [
                        {
                            role: "system",
                            content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€ƒè¯•è¾…å¯¼è€å¸ˆï¼Œæ­£åœ¨å›ç­”å­¦ç”Ÿå…³äºé¢˜ç›®çš„è¿½é—®ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œè¯­è¨€è¦é€šä¿—æ˜“æ‡‚ï¼Œå›ç­”è¦å‡†ç¡®ã€è¯¦ç»†ã€‚"
                        },
                        {
                            role: "user",
                            content: `é¢˜ç›®ï¼š${question.topic}\n\né¢˜ç›®ç±»å‹ï¼š${question.typeName}\n\né€‰é¡¹ï¼š${JSON.stringify(question.optionMap)}\n\næ­£ç¡®ç­”æ¡ˆï¼š${question.answerList.join('ã€')}\n\nè¯·å¯¹è¿™é“é¢˜è¿›è¡Œè¯¦ç»†è§£æã€‚`
                        }
                    ];

                    // æ·»åŠ å†å²å¯¹è¯
                    conversationHistory.forEach(msg => {
                        messages.push({
                            role: msg.role,
                            content: msg.content
                        });
                    });

                    // æ·»åŠ å½“å‰é—®é¢˜
                    messages.push({
                        role: "user",
                        content: message
                    });

                    // è°ƒç”¨DeepSeek API
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-db27d16bfd194749b392e7dddb2cf0c5'
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 800
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        const aiResponse = data.choices[0].message.content;

                        // ç§»é™¤åŠ è½½æ¶ˆæ¯
                        removeAIMessage(loadingId);

                        // æ·»åŠ AIå›å¤
                        addAIMessage('assistant', aiResponse);

                        // ä¿å­˜å¯¹è¯å†å²
                        if (!examData[currentQuestionIndex].aiConversation) {
                            examData[currentQuestionIndex].aiConversation = [];
                        }
                        examData[currentQuestionIndex].aiConversation.push(
                            { role: 'user', content: message },
                            { role: 'assistant', content: aiResponse }
                        );
                        saveExamState();

                        showToast('AIå›å¤å·²å‘é€', 'success');
                    } else {
                        throw new Error('APIå“åº”æ ¼å¼é”™è¯¯');
                    }

                } catch (error) {
                    console.error('AIè¿½é—®å¤±è´¥:', error);
                    removeAIMessage(loadingId);
                    addAIMessage('assistant', `æŠ±æ­‰ï¼ŒAIå›å¤å¤±è´¥ï¼š${error.message}`);
                    showToast('AIè¿½é—®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                } finally {
                    // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
                    aiInput.disabled = false;
                    aiSendBtn.disabled = false;
                    aiInput.focus();
                }
            }

            // æ·»åŠ AIæ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
            function addAIMessage(role, content) {
                const aiConversation = document.getElementById('aiConversation');
                const messageDiv = document.createElement('div');
                const messageId = 'msg_' + Date.now() + '_' + Math.random();
                messageDiv.id = messageId;
                messageDiv.className = `ai-message ${role}`;
                messageDiv.textContent = content;
                aiConversation.appendChild(messageDiv);

                // æ»šåŠ¨åˆ°åº•éƒ¨
                aiConversation.scrollTop = aiConversation.scrollHeight;

                return messageId;
            }

            // ç§»é™¤AIæ¶ˆæ¯
            function removeAIMessage(messageId) {
                const messageDiv = document.getElementById(messageId);
                if (messageDiv) {
                    messageDiv.remove();
                }
            }

            // æ˜¾ç¤ºAIå¯¹è¯å†å²
            function displayAIConversation() {
                const aiConversation = document.getElementById('aiConversation');
                const conversation = examData[currentQuestionIndex].aiConversation || [];

                aiConversation.innerHTML = '';

                conversation.forEach(msg => {
                    addAIMessage(msg.role, msg.content);
                });
            }

            // å¤„ç†AIè¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
            function handleAIInputKeydown(event) {
                if (event.ctrlKey && event.key === 'Enter') {
                    event.preventDefault();
                    sendAIMessage();
                }
            }

            // éšæœºè€ƒè¯•ç›¸å…³å˜é‡
            let randomExamQuestions = [];
            let randomExamAnswers = [];
            let randomExamCompleted = false;

            // å¼€å§‹éšæœºè€ƒè¯•
            function startRandomExam() {
                if (examData.length < 10) {
                    showToast('é¢˜åº“é¢˜ç›®æ•°é‡ä¸è¶³ï¼Œæ— æ³•å¼€å§‹éšæœºè€ƒè¯•', 'warning');
                    return;
                }

                // ç”Ÿæˆéšæœºé¢˜ç›®ï¼ˆåŸºäºç­”é”™æ¬¡æ•°æƒé‡ï¼‰
                randomExamQuestions = generateRandomQuestions(10);
                randomExamAnswers = new Array(10).fill(null);
                randomExamCompleted = false;

                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('randomExamModal').classList.add('show');

                // ç”Ÿæˆé¢˜ç›®å†…å®¹
                generateRandomExamContent();

                // æ›´æ–°è¿›åº¦
                updateRandomExamProgress();

                // ç§»åŠ¨ç«¯è‡ªåŠ¨æŠ˜å é¢˜ç›®å¯¼èˆª
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    closeMobileNav();
                }
            }

            // ç”Ÿæˆéšæœºé¢˜ç›®ï¼ˆåŸºäºç­”é”™æ¬¡æ•°æƒé‡ï¼‰
            function generateRandomQuestions(count) {
                const questions = [];
                const availableQuestions = [...examData];

                // è®¡ç®—æƒé‡ï¼ˆç­”é”™æ¬¡æ•°è¶Šå¤šï¼Œæƒé‡è¶Šé«˜ï¼‰
                const weights = availableQuestions.map(q => (q.wrongCount || 0) + 1);
                let totalWeight = weights.reduce((sum, weight) => sum + weight, 0);

                for (let i = 0; i < count && availableQuestions.length > 0; i++) {
                    // ç”Ÿæˆéšæœºæ•°
                    let random = Math.random() * totalWeight;
                    let selectedIndex = 0;

                    // æ ¹æ®æƒé‡é€‰æ‹©é¢˜ç›®
                    for (let j = 0; j < weights.length; j++) {
                        random -= weights[j];
                        if (random <= 0) {
                            selectedIndex = j;
                            break;
                        }
                    }

                    // æ·»åŠ é€‰ä¸­çš„é¢˜ç›®
                    questions.push(availableQuestions[selectedIndex]);

                    // ä»å¯ç”¨é¢˜ç›®ä¸­ç§»é™¤å·²é€‰ä¸­çš„é¢˜ç›®
                    availableQuestions.splice(selectedIndex, 1);
                    weights.splice(selectedIndex, 1);

                    // é‡æ–°è®¡ç®—æ€»æƒé‡
                    totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                }

                return questions;
            }

            // ç”Ÿæˆéšæœºè€ƒè¯•å†…å®¹
            function generateRandomExamContent() {
                const examBody = document.getElementById('randomExamBody');
                examBody.innerHTML = '';

                randomExamQuestions.forEach((question, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'random-question';
                    questionDiv.innerHTML = `
                        <div class="random-question-header">
                            <span class="random-question-number">ç¬¬ ${index + 1} é¢˜</span>
                            <span class="random-question-score">10åˆ†</span>
                        </div>
                        <div class="random-question-text">${question.topic}</div>
                        <div class="random-options" id="randomOptions${index}">
                            ${generateRandomOptions(question, index)}
                        </div>
                    `;
                    examBody.appendChild(questionDiv);
                });

                // æ·»åŠ é€‰é¡¹ç‚¹å‡»äº‹ä»¶
                addRandomOptionEvents();

                // ç§»åŠ¨ç«¯ä¼˜åŒ–å¸ƒå±€
                const isMobile = window.innerWidth <= 768;
                const examFooter = document.querySelector('.random-exam-footer');
                if (isMobile && examFooter) {
                    examFooter.classList.add('mobile');
                    // ç¡®ä¿æŒ‰é’®å¸ƒå±€æ­£ç¡®
                    const buttonsContainer = examFooter.querySelector('.random-exam-buttons');
                    if (buttonsContainer) {
                        buttonsContainer.style.display = 'flex';
                        buttonsContainer.style.gap = '10px';
                        buttonsContainer.style.justifyContent = 'center';
                        buttonsContainer.style.width = '100%';
                    }
                }
            }

            // ç”Ÿæˆéšæœºé¢˜ç›®é€‰é¡¹
            function generateRandomOptions(question, questionIndex) {
                let options = '';
                const optionMap = Array.isArray(question.optionMap) ? question.optionMap[0] : question.optionMap;

                Object.entries(optionMap).forEach(([key, value]) => {
                    options += `
                        <div class="random-option" data-question="${questionIndex}" data-option="${key}">
                            <input type="radio" name="random_question_${questionIndex}" value="${key}" style="margin-right: 10px; pointer-events: none;">
                            <span>${key}. ${value}</span>
                        </div>
                    `;
                });

                return options;
            }

            // æ·»åŠ éšæœºé€‰é¡¹ç‚¹å‡»äº‹ä»¶
            function addRandomOptionEvents() {
                document.querySelectorAll('.random-option').forEach(option => {
                    option.addEventListener('click', function (event) {
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…é‡å¤è§¦å‘
                        event.preventDefault();
                        event.stopPropagation();

                        const questionIndex = parseInt(this.dataset.question);
                        const optionValue = this.dataset.option;
                        const radioInput = this.querySelector('input[type="radio"]');

                        // æ›´æ–°å•é€‰æŒ‰é’®çŠ¶æ€
                        radioInput.checked = true;

                        // æ›´æ–°ç­”æ¡ˆ
                        randomExamAnswers[questionIndex] = optionValue;

                        // æ›´æ–°é€‰é¡¹æ ·å¼
                        updateRandomOptionStyles(questionIndex, optionValue);

                        // æ›´æ–°è¿›åº¦
                        updateRandomExamProgress();
                    });
                });
            }

            // æ›´æ–°éšæœºé€‰é¡¹æ ·å¼
            function updateRandomOptionStyles(questionIndex, selectedOption) {
                const optionsContainer = document.getElementById(`randomOptions${questionIndex}`);
                const options = optionsContainer.querySelectorAll('.random-option');

                options.forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.option === selectedOption) {
                        option.classList.add('selected');
                    }
                });
            }

            // æ›´æ–°éšæœºè€ƒè¯•è¿›åº¦
            function updateRandomExamProgress() {
                const answeredCount = randomExamAnswers.filter(answer => answer !== null).length;
                const progressElement = document.getElementById('randomExamProgress');
                const submitBtn = document.getElementById('submitRandomExamBtn');

                progressElement.textContent = `å·²ç­”é¢˜: ${answeredCount}/10`;
                submitBtn.disabled = answeredCount < 10;
            }

            // æäº¤éšæœºè€ƒè¯•
            function submitRandomExam() {
                if (randomExamCompleted) return;

                randomExamCompleted = true;

                // è®¡ç®—åˆ†æ•°å¹¶åŒæ­¥æ›´æ–°ä¸»è€ƒè¯•ç³»ç»Ÿæ•°æ®
                let totalScore = 0;
                const results = [];

                randomExamQuestions.forEach((question, index) => {
                    const userAnswer = randomExamAnswers[index];
                    const correctAnswer = question.answerList;
                    const isCorrect = userAnswer && correctAnswer.includes(userAnswer);

                    if (isCorrect) {
                        totalScore += 10;
                    }

                    results.push({
                        question: question,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer,
                        isCorrect: isCorrect,
                        score: isCorrect ? 10 : 0
                    });

                    // åŒæ­¥æ›´æ–°ä¸»è€ƒè¯•ç³»ç»Ÿæ•°æ®
                    syncRandomExamResultToMainSystem(question, userAnswer, isCorrect);
                });

                // æ›´æ–°ä¸»è€ƒè¯•ç³»ç»Ÿçš„ç»Ÿè®¡ä¿¡æ¯
                updateStats();
                updateQuestionNavStatus();

                // ä¿å­˜è€ƒè¯•çŠ¶æ€
                saveExamState();

                // æ˜¾ç¤ºç»“æœ
                showRandomExamResults(totalScore, results);

                // æ»šåŠ¨åˆ°é¡¶éƒ¨ä»¥æ˜¾ç¤ºåˆ†æ•°
                const examBody = document.getElementById('randomExamBody');
                examBody.scrollTop = 0;

                // æç¤ºç”¨æˆ·æ•°æ®å·²åŒæ­¥
                showToast('éšæœºè€ƒè¯•ç»“æœå·²åŒæ­¥åˆ°ä¸»è€ƒè¯•ç³»ç»Ÿ', 'success');
            }

            // å°†éšæœºè€ƒè¯•ç»“æœåŒæ­¥åˆ°ä¸»è€ƒè¯•ç³»ç»Ÿ
            function syncRandomExamResultToMainSystem(question, userAnswer, isCorrect) {
                // åœ¨ä¸»è€ƒè¯•ç³»ç»Ÿä¸­æ‰¾åˆ°å¯¹åº”çš„é¢˜ç›®
                const mainQuestionIndex = examData.findIndex(q => q.num === question.num);

                if (mainQuestionIndex !== -1) {
                    const mainQuestion = examData[mainQuestionIndex];

                    // æ›´æ–°ç”¨æˆ·ç­”æ¡ˆ
                    mainQuestion.userAnswer = userAnswer ? [userAnswer] : [];

                    // æ·»åŠ åˆ°å·²ç­”é¢˜é›†åˆ
                    answeredQuestions.add(mainQuestionIndex);

                    // æ›´æ–°ç»Ÿè®¡è®¡æ•°
                    if (isCorrect) {
                        // å¦‚æœä¹‹å‰æ²¡æœ‰ç­”è¿‡æˆ–è€…ä¹‹å‰ç­”é”™äº†ï¼Œç°åœ¨ç­”å¯¹äº†
                        if (!answeredQuestions.has(mainQuestionIndex) ||
                            (mainQuestion.userAnswer && !isAnswerCorrect(mainQuestion))) {
                            correctCount++;
                            // å¦‚æœä¹‹å‰ç­”é”™äº†ï¼Œç°åœ¨ç­”å¯¹äº†ï¼Œéœ€è¦å‡å°‘é”™è¯¯è®¡æ•°
                            if (answeredQuestions.has(mainQuestionIndex) &&
                                mainQuestion.userAnswer && !isAnswerCorrect(mainQuestion)) {
                                incorrectCount--;
                            }
                        }
                    } else {
                        // ç­”é”™äº†
                        if (!answeredQuestions.has(mainQuestionIndex)) {
                            incorrectCount++;
                        } else if (mainQuestion.userAnswer && isAnswerCorrect(mainQuestion)) {
                            // å¦‚æœä¹‹å‰ç­”å¯¹äº†ï¼Œç°åœ¨ç­”é”™äº†
                            correctCount--;
                            incorrectCount++;
                        }

                        // è®°å½•ç­”é”™æ¬¡æ•°
                        if (!mainQuestion.wrongCount) {
                            mainQuestion.wrongCount = 0;
                        }
                        mainQuestion.wrongCount++;
                    }
                }
            }

            // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
            function isAnswerCorrect(question) {
                const userAnswer = question.userAnswer || [];
                return question.answerList.length === userAnswer.length &&
                    question.answerList.every(ans => userAnswer.includes(ans)) &&
                    userAnswer.every(ans => question.answerList.includes(ans));
            }

            // æ˜¾ç¤ºéšæœºè€ƒè¯•ç»“æœ
            function showRandomExamResults(totalScore, results) {
                const examBody = document.getElementById('randomExamBody');
                const submitBtn = document.getElementById('submitRandomExamBtn');

                // æ›´æ–°é€‰é¡¹æ ·å¼æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                results.forEach((result, index) => {
                    const optionsContainer = document.getElementById(`randomOptions${index}`);
                    const options = optionsContainer.querySelectorAll('.random-option');

                    options.forEach(option => {
                        const optionValue = option.dataset.option;
                        option.classList.remove('selected', 'correct', 'incorrect');

                        if (result.correctAnswer.includes(optionValue)) {
                            option.classList.add('correct');
                        } else if (optionValue === result.userAnswer) {
                            option.classList.add('incorrect');
                        }
                    });
                });

                // åœ¨é¡¶éƒ¨æ˜¾ç¤ºæ€»åˆ†
                const scoreDiv = document.createElement('div');
                scoreDiv.style.cssText = 'text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;';
                scoreDiv.innerHTML = `
                    <h2 style="color: #28a745; margin: 0 0 10px 0;">ğŸ‰ è€ƒè¯•å®Œæˆï¼</h2>
                    <div style="font-size: 36px; font-weight: bold; color: #667eea;">${totalScore}åˆ†</div>
                    <div style="color: #6c757d; margin-top: 5px;">æ»¡åˆ†: 100åˆ†</div>
                    <div style="color: #17a2b8; margin-top: 10px; font-size: 14px; padding: 8px; background: #e3f2fd; border-radius: 6px;">
                        âœ… ç­”é¢˜ç»“æœå·²åŒæ­¥åˆ°ä¸»è€ƒè¯•ç³»ç»Ÿï¼Œå¯åœ¨é¢˜ç›®å¯¼èˆªä¸­æŸ¥çœ‹ç­”é¢˜çŠ¶æ€
                    </div>
                `;
                examBody.insertBefore(scoreDiv, examBody.firstChild);

                // æ›´æ–°æŒ‰é’®
                submitBtn.textContent = 'é‡æ–°å¼€å§‹';
                submitBtn.onclick = startRandomExam;

                // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç¡®ä¿æŒ‰é’®å¸ƒå±€æ­£ç¡®
                const isMobile = window.innerWidth <= 768;
                const examFooter = document.querySelector('.random-exam-footer');
                if (isMobile && examFooter) {
                    examFooter.classList.add('mobile');
                    // ç¡®ä¿æŒ‰é’®å¸ƒå±€æ­£ç¡®
                    const buttonsContainer = examFooter.querySelector('.random-exam-buttons');
                    if (buttonsContainer) {
                        buttonsContainer.style.display = 'flex';
                        buttonsContainer.style.gap = '10px';
                        buttonsContainer.style.justifyContent = 'center';
                        buttonsContainer.style.width = '100%';
                    }
                }

                showToast(`éšæœºè€ƒè¯•å®Œæˆï¼å¾—åˆ†ï¼š${totalScore}åˆ†`, 'success');
            }

            // å…³é—­éšæœºè€ƒè¯•
            function closeRandomExam() {
                document.getElementById('randomExamModal').classList.remove('show');
                randomExamQuestions = [];
                randomExamAnswers = [];
                randomExamCompleted = false;
            }

            // åˆ‡æ¢å¯¼èˆªæ˜¾ç¤º/éšè—
            function toggleNav() {
                const questionNav = document.getElementById('questionNav');
                const navToggleBtn = document.getElementById('navToggleBtn');
                const navOverlay = document.getElementById('navOverlay');
                const container = document.querySelector('.container');

                // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    // ç§»åŠ¨ç«¯é€»è¾‘
                    if (questionNav.classList.contains('show')) {
                        // éšè—å¯¼èˆª
                        questionNav.classList.remove('show');
                        navToggleBtn.classList.remove('show');
                        navToggleBtn.innerHTML = 'â˜°';
                        navOverlay.classList.remove('show');
                    } else {
                        // æ˜¾ç¤ºå¯¼èˆª
                        questionNav.classList.add('show');
                        navToggleBtn.classList.add('show');
                        navToggleBtn.innerHTML = 'âœ•';
                        navOverlay.classList.add('show');
                    }
                } else {
                    // æ¡Œé¢ç«¯é€»è¾‘
                    if (questionNav.classList.contains('collapsed')) {
                        // æ˜¾ç¤ºå¯¼èˆª
                        questionNav.classList.remove('collapsed');
                        navToggleBtn.classList.remove('collapsed');
                        navToggleBtn.innerHTML = 'â—€';
                        container.classList.remove('nav-collapsed');
                    } else {
                        // éšè—å¯¼èˆª
                        questionNav.classList.add('collapsed');
                        navToggleBtn.classList.add('collapsed');
                        navToggleBtn.innerHTML = 'â–¶';
                        container.classList.add('nav-collapsed');
                    }
                }
            }

            // åˆå§‹åŒ–å¯¼èˆªæŒ‰é’®çŠ¶æ€
            function initNavButtonState() {
                const navToggleBtn = document.getElementById('navToggleBtn');
                const container = document.querySelector('.container');
                const isMobile = window.innerWidth <= 768;

                if (isMobile) {
                    navToggleBtn.innerHTML = 'â˜°';
                    // ç§»åŠ¨ç«¯é»˜è®¤éšè—å¯¼èˆªï¼Œå®¹å™¨å±…ä¸­
                    container.classList.add('nav-collapsed');
                } else {
                    navToggleBtn.innerHTML = 'â—€';
                    // æ¡Œé¢ç«¯é»˜è®¤æ˜¾ç¤ºå¯¼èˆªï¼Œå®¹å™¨åç§»
                    container.classList.remove('nav-collapsed');
                }
            }

            // å…³é—­ç§»åŠ¨ç«¯å¯¼èˆª
            function closeMobileNav() {
                const questionNav = document.getElementById('questionNav');
                const navToggleBtn = document.getElementById('navToggleBtn');
                const navOverlay = document.getElementById('navOverlay');

                questionNav.classList.remove('show');
                navToggleBtn.classList.remove('show');
                navToggleBtn.innerHTML = 'â˜°';
                navOverlay.classList.remove('show');
            }

            // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
            document.addEventListener('DOMContentLoaded', function () {
                loadExamData();
                initNavButtonState();
                adjustMobileButtons();
            });

            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
            window.addEventListener('resize', function () {
                initNavButtonState();
                adjustMobileButtons();
            });

            // è°ƒæ•´ç§»åŠ¨ç«¯æŒ‰é’®å¸ƒå±€
            function adjustMobileButtons() {
                const isMobile = window.innerWidth <= 768;
                const actionsRow = document.querySelector('.actions-row');

                if (isMobile && actionsRow) {
                    // ç§»åŠ¨ç«¯ï¼šä¸‰ä¸ªæŒ‰é’®åœ¨åŒä¸€è¡Œ
                    const prevBtn = document.getElementById('prevBtn');
                    const submitBtn = document.getElementById('submitBtn');
                    const nextBtn = document.getElementById('nextBtn');

                    // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ æŒ‰é’®
                    actionsRow.innerHTML = '';
                    actionsRow.appendChild(prevBtn);
                    actionsRow.appendChild(submitBtn);
                    actionsRow.appendChild(nextBtn);
                } else if (actionsRow) {
                    // æ¡Œé¢ç«¯ï¼šæ¢å¤åŸå§‹å¸ƒå±€
                    const prevBtn = document.getElementById('prevBtn');
                    const submitBtn = document.getElementById('submitBtn');
                    const nextBtn = document.getElementById('nextBtn');

                    // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ æŒ‰é’®
                    actionsRow.innerHTML = '';
                    actionsRow.appendChild(prevBtn);
                    actionsRow.appendChild(submitBtn);
                    actionsRow.appendChild(nextBtn);
                }
            }
        </script>
</body>

</html>
